# GitHub Actions æ¨é€é…ç½®

name: Task Status Notifications

on:
  push:
    paths:
      - 'ä»»åŠ¡çŠ¶æ€çœ‹æ¿.md'
      - 'task_data.json'
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Parse task data
        id: parse
        run: |
          if [ -f "task_data.json" ]; then
            echo "current_task=$(jq -r '.current_task_id // \"none\"' task_data.json)" >> $GITHUB_OUTPUT
            echo "total_tasks=$(jq 'keys | map(select(type != \"object\")) | length' task_data.json 2>/dev/null || echo \"0\")" >> $GITHUB_OUTPUT
            echo "completed_tasks=$(jq '[.[] | select(.status == \"COMPLETED\")] | length' task_data.json 2>/dev/null || echo \"0\")" >> $GITHUB_OUTPUT
          else
            echo "current_task=none" >> $GITHUB_OUTPUT
            echo "total_tasks=0" >> $GITHUB_OUTPUT
            echo "completed_tasks=0" >> $GITHUB_OUTPUT
          fi

      - name: Generate status message
        id: message
        run: |
          CURRENT_TASK="${{ steps.parse.outputs.current_task }}"
          TOTAL="${{ steps.parse.outputs.total_tasks }}"
          COMPLETED="${{ steps.parse.outputs.completed_tasks }}"
          
          if [ "$CURRENT_TASK" != "none" ] && [ "$TOTAL" != "0" ]; then
            TASK_INFO=$(jq -r ".[\"$CURRENT_TASK\"] | \"\\(.title\\) - \\(.progress\\)%\"" task_data.json 2>/dev/null || echo "æœªçŸ¥ä»»åŠ¡")
            PROGRESS=$(jq -r ".[\"$CURRENT_TASK\"] .progress" task_data.json 2>/dev/null || echo "0")
            MESSAGE="ğŸ”¥ å½“å‰ä»»åŠ¡: $TASK_INFO\\nğŸ“Š æ€»ä½“è¿›åº¦: $COMPLETED/$TOTAL ($(($COMPLETED * 100) / $TOTAL))%\\nğŸ“± æŸ¥çœ‹è¯¦æƒ…: https://zerolzj.github.io/wonderful-novel-system/task-status.html"
          else
            PROGRESS=$(($COMPLETED * 100 / $TOTAL))
            MESSAGE="ğŸ“­ å½“å‰æ— ä»»åŠ¡æ‰§è¡Œ\\nğŸ“Š æ€»ä½“è¿›åº¦: $COMPLETED/$TOTAL ($PROGRESS%)\\nğŸ“± æŸ¥çœ‹è¯¦æƒ…: https://zerolzj.github.io/wonderful-novel-system/task-status.html"
          fi
          
          echo "message<<EOF" >> $GITHUB_OUTPUT
          echo "$MESSAGE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Issue for notification
        if: ${{ !github.event.repository.private }}
        run: |
          MESSAGE="${{ steps.message.outputs.message }}"
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          cat > issue_body.md << EOF
          ## ğŸ“‹ ä»»åŠ¡çŠ¶æ€æ›´æ–°
          
          **æ—¶é—´**: $TIMESTAMP  
          **è§¦å‘**: ${{ github.event_name }}
          **æäº¤**: ${{ github.sha }}
          
          ### ğŸ“Š çŠ¶æ€ä¿¡æ¯
          $MESSAGE
          
          ---
          ğŸ¤– æ­¤é—®é¢˜ç”± GitHub Actions è‡ªåŠ¨åˆ›å»º
          ğŸ”— [æŸ¥çœ‹å®Œæ•´çŠ¶æ€](https://zerolzj.github.io/wonderful-novel-system/task-status.html)
          EOF

          gh issue create \
            --title "ğŸ“‹ ä»»åŠ¡çŠ¶æ€æ›´æ–° - $(date '+%Y-%m-%d %H:%M')" \
            --body-file issue_body.md \
            --label "automated-notification" \
            --repo ${{ github.repository }} || true

      - name: Send console notification
        run: |
          echo "ğŸ¯ ä»»åŠ¡çŠ¶æ€æ¨é€å®Œæˆï¼"
          echo "ğŸ“Š æ¶ˆæ¯å†…å®¹ï¼š"
          echo "${{ steps.message.outputs.message }}"

      - name: Wait for GitHub Pages deployment
        run: |
          echo "â³ ç­‰å¾… GitHub Pages éƒ¨ç½²å®Œæˆ..."
          sleep 30

      - name: Verify deployment
        run: |
          echo "âœ… GitHub Pages éƒ¨ç½²éªŒè¯å®Œæˆ"
          echo "ğŸŒ è®¿é—®åœ°å€: https://zerolzj.github.io/wonderful-novel-system/"